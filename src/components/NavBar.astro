---
import { Image } from 'astro:assets'
import vollrathLogo from '../images/vollrath_logo.svg'

const currentPath = new URL(Astro.request.url).pathname.replace(/\/$/, '') || '/'

const navItems = [
	{ path: '/', label: 'Home', id: 'home-link' },
	{ path: '/about', label: 'About', id: 'about-link' },
	{ path: '/now', label: 'Now', id: 'now-link' },
	{ path: '/renders', label: 'Renders', id: 'renders-link' },
	{ path: '/blog', label: 'Blog', id: 'blog-link', additionalPaths: ['/posts'] }
]

function isPathActive(itemPath, additionalPaths = []) {
	console.log('Checking path:', itemPath)
	console.log('Current Path:', currentPath)
	return (
		currentPath === itemPath || additionalPaths.some((addPath) => currentPath.startsWith(addPath))
	)
}
---

<nav
	class="nav-bar border-gradient sticky top-0 z-10 mb-4 flex items-center justify-between rounded-md bg-white from-dark-card to-darker-card px-4 shadow-lg dark:bg-gradient-to-r sm:static sm:z-0 sm:mb-8 sm:rounded-lg sm:px-12 lg:col-span-3"
	data-current-path={currentPath}
>
	<Image src={vollrathLogo} class="mr-2 h-auto w-10 py-2 sm:w-16 sm:py-3" alt="Vollrath Logo" />

	<!-- Hamburger Icon -->
	<div class="flex cursor-pointer flex-col space-y-1 sm:space-y-2 lg:hidden" id="hamburger">
		<span class="block h-0.5 w-5 bg-dark-text sm:w-8"></span>
		<span class="block h-0.5 w-5 bg-dark-text sm:w-8"></span>
		<span class="block h-0.5 w-5 bg-dark-text sm:w-8"></span>
	</div>

	<div
		class="invisible z-30 flex select-none flex-col font-header text-xl md:flex-row lg:visible"
		id="nav-menu"
	>
		{
			navItems.map((item) => (
				<a
					href={item.path}
					class={`nav-item px-4 py-2 font-medium transition hover:text-dark-text ${isPathActive(item.path, item.additionalPaths) ? 'gradient-underline text-dark-text' : ' text-gray-400'}`}
					id={item.id}
				>
					{item.label}
				</a>
			))
		}
		<div id="nav-underline" class="nav-underline invisible lg:visible"></div>
	</div>
</nav>

<script is:inline>
	let lastUnderlinePosition = { left: 0, width: 0 }

	function saveUnderlinePosition() {
		const underline = document.querySelector('#nav-underline')
		if (underline) {
			const style = window.getComputedStyle(underline)
			lastUnderlinePosition.left = parseInt(style.left, 10)
			lastUnderlinePosition.width = parseInt(style.width, 10)
		}
	}

	function initMenu() {
		const hamburger = document.getElementById('hamburger')
		const navMenu = document.getElementById('nav-menu')

		if (hamburger && navMenu) {
			hamburger.addEventListener('click', () => {
				navMenu.classList.toggle('invisible')

				// Check if the menu is now visible
				if (!navMenu.classList.contains('invisible')) {
					// Disable scrolling
					document.body.style.overflow = 'hidden'
				} else {
					// Re-enable scrolling
					document.body.style.overflow = ''
				}
			})
		}
	}

	function updateUnderline() {
		const underline = document.querySelector('#nav-underline')
		const activeItem = document.querySelector('.nav-item.gradient-underline')
		console.log('Active Item:', activeItem)

		if (!activeItem) {
			console.log('No active item found.')
			return
		}

		const navMenu = document.querySelector('#nav-menu')
		const activeItemRect = activeItem.getBoundingClientRect()
		const navMenuRect = navMenu.getBoundingClientRect()

		const newLeft = activeItemRect.left + 10 - navMenuRect.left
		const newWidth = activeItem.offsetWidth - 20

		const movingRight = newLeft > lastUnderlinePosition.left

		underline.style.left = `${movingRight ? lastUnderlinePosition.left : lastUnderlinePosition.left + lastUnderlinePosition.width - newWidth}px`
		underline.style.width = `${lastUnderlinePosition.width}px`

		requestAnimationFrame(() => {
			underline.style.left = `${newLeft}px`
			underline.style.width = `${newWidth}px`
		})
	}

	document.addEventListener('astro:before-swap', saveUnderlinePosition)
	document.addEventListener('astro:after-swap', updateUnderline)
	document.addEventListener('astro:after-swap', initMenu)
	document.addEventListener('DOMContentLoaded', () => {
		const navBar = document.querySelector('nav[data-current-path]')
		const currentPath = navBar ? navBar.getAttribute('data-current-path') : null

		console.log('DOM fully loaded. Current Path:', currentPath)
		initMenu()
		updateUnderline()
	})
	window.addEventListener('resize', updateUnderline)
</script>
